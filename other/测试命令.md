# Sandbox API 测试命令

所有请求都需要在请求头中提供 `x-sandbox-id` 来指定沙箱 ID。

## 1. 生命周期管理 (`/lifecycle`)

### 创建并初始化沙箱容器
```bash
curl -X POST "http://localhost:8787/lifecycle" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{"options":{"sleepAfter":"5m","keepAlive":true}}'
```

curl -X POST "https://server.435669237.workers.dev" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{"options":{"sleepAfter":"5m","keepAlive":true}}'

**选项说明：**
- `sleepAfter`: 容器空闲多久后休眠（如 "5m", "10m"）
- `keepAlive`: 是否保持容器存活

### 销毁沙箱容器
```bash
curl -X DELETE "http://localhost:8787/lifecycle" \
  -H "x-sandbox-id: sb-123"
```

---

## 2. 非会话执行 (`/exec`)

直接在沙箱容器中执行命令，无需创建会话。

### 基本执行
```bash
curl -X POST "http://localhost:8787/exec" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{"command":"ls -la"}'
```

### 带选项执行（工作目录、环境变量、超时）
```bash
curl -X POST "http://localhost:8787/exec" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{
    "command": "echo $MY_VAR && pwd",
    "options": {
      "cwd": "/tmp",
      "env": {"MY_VAR": "hello"},
      "timeout": 10000
    }
  }'
```

**选项说明：**
- `cwd`: 工作目录
- `env`: 环境变量对象
- `timeout`: 超时时间（毫秒）

---

## 3. 会话管理 (`/session`)

### 创建会话（body.session.id 优先，query.session_id 作为备选）

**方式 1：body 中指定 session.id**
```bash
curl -X POST "http://localhost:8787/session?session_id=s1" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{
    "session": {
      "id": "s1",
      "env": {"HELLO": "WORLD"},
      "cwd": "/tmp"
    }
  }'
```

**方式 2：使用 query 参数 session_id（body 不传 id）**
```bash
curl -X POST "http://localhost:8787/session?session_id=s2" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{
    "session": {
      "env": {"HELLO": "QUERY_ID"},
      "cwd": "/tmp"
    }
  }'
```

**方式 3：简化 body（直接传 session 选项）**
```bash
curl -X POST "http://localhost:8787/session?session_id=s3" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{
    "env": {"HELLO": "WORLD"},
    "cwd": "/workspace"
  }'
```

### 获取会话信息
```bash
curl -X GET "http://localhost:8787/session?session_id=s1" \
  -H "x-sandbox-id: sb-123"
```

### 删除会话
```bash
curl -X DELETE "http://localhost:8787/session?session_id=s1" \
  -H "x-sandbox-id: sb-123"
```

---

## 4. 会话执行 (`/session/exec`)

在指定会话中执行命令，会话会维护独立的工作目录和环境变量。

### 基本会话执行（sessionId 在 body 中）
```bash
curl -X POST "http://localhost:8787/session/exec" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{
    "sessionId": "s1",
    "command": "pwd"
  }'
```

### 使用 query 参数传递 sessionId
```bash
curl -X POST "http://localhost:8787/session/exec?session_id=s1" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{
    "command": "ls -la"
  }'
```

### 带选项的会话执行
```bash
curl -X POST "http://localhost:8787/session/exec?session_id=s1" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{
    "command": "echo $HELLO && pwd",
    "options": {
      "cwd": "/workspace",
      "env": {"HELLO": "SESSION_VAR"},
      "timeout": 5000
    }
  }'
```

**注意：** sessionId 可以通过以下方式传递（优先级从高到低）：
1. `body.sessionId`
2. `body.session_id`
3. `query.session_id`

---

## 5. Bucket 挂载管理 (`/mount-bucket`, `/unmount-bucket`)

### 挂载 S3 兼容的 Bucket

将 R2、S3 或 GCS bucket 挂载到沙箱的文件系统中。

#### 基本挂载（使用环境变量中的凭证）

```bash
curl -X POST "http://localhost:8787/mount-bucket" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{
    "bucket": "my-r2-bucket",
    "mountPath": "/data",
    "options": {
      "endpoint": "https://YOUR_ACCOUNT_ID.r2.cloudflarestorage.com"
    }
  }'
```

#### 带凭证的挂载

```bash
curl -X POST "http://localhost:8787/mount-bucket" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{
    "bucket": "my-r2-bucket",
    "mountPath": "/data",
    "options": {
      "endpoint": "https://YOUR_ACCOUNT_ID.r2.cloudflarestorage.com",
      "provider": "r2",
      "credentials": {
        "accessKeyId": "your-access-key-id",
        "secretAccessKey": "your-secret-access-key"
      }
    }
  }'
```

#### 只读模式挂载

```bash
curl -X POST "http://localhost:8787/mount-bucket" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{
    "bucket": "my-r2-bucket",
    "mountPath": "/data",
    "options": {
      "endpoint": "https://YOUR_ACCOUNT_ID.r2.cloudflarestorage.com",
      "readOnly": true
    }
  }'
```

#### 在会话中挂载

```bash
curl -X POST "http://localhost:8787/mount-bucket" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{
    "bucket": "my-r2-bucket",
    "mountPath": "/data",
    "sessionId": "s1",
    "options": {
      "endpoint": "https://YOUR_ACCOUNT_ID.r2.cloudflarestorage.com"
    }
  }'
```

**选项说明：**
- `bucket`: Bucket 名称（必需）
- `mountPath`: 挂载路径（必需，如 `/data`, `/mnt/bucket`）
- `sessionId`: 可选，指定在哪个会话中挂载
- `options.endpoint`: S3 兼容 API 端点（必需）
- `options.provider`: 可选，`"r2"` | `"s3"` | `"gcs"`，默认自动检测
- `options.credentials`: 可选，如果不提供会从环境变量自动读取
  - `accessKeyId`: 访问密钥 ID
  - `secretAccessKey`: 密钥
- `options.readOnly`: 可选，是否只读模式（默认 `false`）
- `options.s3fsOptions`: 可选，高级 s3fs 选项数组

**响应示例：**
```json
{
  "sandboxId": "sb-123",
  "sessionId": null,
  "bucket": "my-r2-bucket",
  "mountPath": "/data",
  "mounted": true,
  "options": {
    "endpoint": "https://YOUR_ACCOUNT_ID.r2.cloudflarestorage.com"
  }
}
```

### 卸载 Bucket

#### 使用 DELETE 方法（查询参数）

```bash
curl -X DELETE "http://localhost:8787/unmount-bucket?mountPath=/data" \
  -H "x-sandbox-id: sb-123"
```

#### 使用 POST 方法（JSON body）

```bash
curl -X POST "http://localhost:8787/unmount-bucket" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{
    "mountPath": "/data"
  }'
```

#### 卸载会话中的 Bucket

```bash
curl -X DELETE "http://localhost:8787/unmount-bucket?mountPath=/data&sessionId=s1" \
  -H "x-sandbox-id: sb-123"
```

**参数说明：**
- `mountPath`: 挂载路径（必需，可通过 `path` 别名传递）
- `sessionId`: 可选，指定在哪个会话中卸载

**响应示例：**
```json
{
  "sandboxId": "sb-123",
  "sessionId": null,
  "mountPath": "/data",
  "unmounted": true
}
```

---

## 6. 完整工作流示例

### 场景 1：在会话中执行多个命令，保持状态

```bash
# 1. 创建沙箱
curl -X POST "http://localhost:8787/lifecycle" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{"options":{"keepAlive":true}}'

# 2. 创建会话，设置工作目录和环境变量
curl -X POST "http://localhost:8787/session?session_id=my-session" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{
    "session": {
      "cwd": "/workspace",
      "env": {"PROJECT": "my-project"}
    }
  }'

# 3. 在会话中执行命令（会继承会话的 cwd 和 env）
curl -X POST "http://localhost:8787/session/exec?session_id=my-session" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{"command": "pwd"}'
# 输出: /workspace

curl -X POST "http://localhost:8787/session/exec?session_id=my-session" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{"command": "echo $PROJECT"}'
# 输出: my-project

# 4. 清理：删除会话
curl -X DELETE "http://localhost:8787/session?session_id=my-session" \
  -H "x-sandbox-id: sb-123"

# 5. 清理：销毁沙箱
curl -X DELETE "http://localhost:8787/lifecycle" \
  -H "x-sandbox-id: sb-123"
```

### 场景 2：挂载 Bucket 并操作文件

```bash
# 1. 创建沙箱
curl -X POST "http://localhost:8787/lifecycle" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{"options":{"keepAlive":true}}'

# 2. 挂载 R2 bucket 到 /data
curl -X POST "http://localhost:8787/mount-bucket" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{
    "bucket": "my-r2-bucket",
    "mountPath": "/data",
    "options": {
      "endpoint": "https://YOUR_ACCOUNT_ID.r2.cloudflarestorage.com"
    }
  }'

# 3. 列出挂载目录中的文件
curl -X POST "http://localhost:8787/exec" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{"command": "ls -la /data"}'

# 4. 读取 bucket 中的文件
curl -X POST "http://localhost:8787/exec" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{"command": "cat /data/my-file.txt"}'

# 5. 写入文件到 bucket
curl -X POST "http://localhost:8787/exec" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{"command": "echo \"Hello from sandbox\" > /data/output.txt"}'

# 6. 卸载 bucket
curl -X DELETE "http://localhost:8787/unmount-bucket?mountPath=/data" \
  -H "x-sandbox-id: sb-123"

# 7. 清理：销毁沙箱
curl -X DELETE "http://localhost:8787/lifecycle" \
  -H "x-sandbox-id: sb-123"
```

### 场景 3：在会话中挂载 Bucket 并处理数据

```bash
# 1. 创建沙箱
curl -X POST "http://localhost:8787/lifecycle" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{"options":{"keepAlive":true}}'

# 2. 创建会话
curl -X POST "http://localhost:8787/session?session_id=data-processing" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{
    "session": {
      "cwd": "/workspace",
      "env": {"BUCKET_PATH": "/data"}
    }
  }'

# 3. 在会话中挂载 bucket
curl -X POST "http://localhost:8787/mount-bucket" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{
    "bucket": "my-r2-bucket",
    "mountPath": "/data",
    "sessionId": "data-processing",
    "options": {
      "endpoint": "https://YOUR_ACCOUNT_ID.r2.cloudflarestorage.com"
    }
  }'

# 4. 在会话中处理 bucket 数据
curl -X POST "http://localhost:8787/session/exec?session_id=data-processing" \
  -H "x-sandbox-id: sb-123" \
  -H "Content-Type: application/json" \
  -d '{"command": "cd $BUCKET_PATH && ls -la"}'

# 5. 清理：卸载 bucket
curl -X DELETE "http://localhost:8787/unmount-bucket?mountPath=/data&sessionId=data-processing" \
  -H "x-sandbox-id: sb-123"

# 6. 清理：删除会话
curl -X DELETE "http://localhost:8787/session?session_id=data-processing" \
  -H "x-sandbox-id: sb-123"

# 7. 清理：销毁沙箱
curl -X DELETE "http://localhost:8787/lifecycle" \
  -H "x-sandbox-id: sb-123"
```

---

## 7. `/exec` vs `/session/exec` 区别

| 特性 | `/exec` | `/session/exec` |
|------|---------|-----------------|
| **执行环境** | 沙箱容器级别 | 会话（session）级别 |
| **是否需要 sessionId** | ❌ 否 | ✅ 是 |
| **状态隔离** | 无会话隔离 | 有会话隔离 |
| **工作目录** | 沙箱默认目录 | 会话独立目录 |
| **环境变量** | 沙箱级别 | 会话级别 |
| **适用场景** | 一次性命令执行 | 需要状态保持的交互式执行 |

**使用建议：**
- 使用 `/exec` 执行一次性命令（如 `ls`, `cat file.txt`, `npm install`）
- 使用 `/session/exec` 执行需要状态保持的命令序列（如先 `cd /workspace`，后续命令在该目录执行）

---

## 8. Bucket 挂载注意事项

### 凭证管理

**方式 1：通过请求 body 传递（推荐用于临时访问）**
```json
{
  "options": {
    "credentials": {
      "accessKeyId": "your-key",
      "secretAccessKey": "your-secret"
    }
  }
}
```

**方式 2：通过环境变量（推荐用于生产环境）**
如果不提供 `credentials`，SDK 会自动从以下环境变量读取：
- `R2_ACCESS_KEY_ID` / `AWS_ACCESS_KEY_ID`
- `R2_SECRET_ACCESS_KEY` / `AWS_SECRET_ACCESS_KEY`

### 端点配置

**Cloudflare R2：**
```
https://YOUR_ACCOUNT_ID.r2.cloudflarestorage.com
```

**AWS S3：**
```
https://s3.amazonaws.com
# 或区域特定端点
https://s3.us-east-1.amazonaws.com
```

**Google Cloud Storage：**
```
https://storage.googleapis.com
```

### 挂载路径建议

- ✅ 使用绝对路径：`/data`, `/mnt/bucket`, `/workspace/storage`
- ❌ 避免使用系统目录：`/`, `/bin`, `/usr`, `/etc`
- ✅ 建议使用有意义的路径名：`/data`, `/storage`, `/backup`

### 错误处理

**常见错误码：**
- `400`: 参数验证错误（缺少必需参数、无效的 endpoint 等）
- `404`: 沙箱、会话或挂载点不存在
- `500`: 服务器内部错误（挂载失败、网络问题等）

**错误响应示例：**
```json
{
  "sandboxId": "sb-123",
  "sessionId": null,
  "bucket": "my-bucket",
  "mountPath": "/data",
  "error": "MissingCredentialsError: Credentials not found"
}
```

### 最佳实践

1. **挂载时机**：在创建沙箱后、执行命令前挂载 bucket
2. **清理资源**：使用完毕后及时卸载 bucket，避免资源泄漏
3. **只读模式**：对于只需要读取的场景，使用 `readOnly: true`
4. **会话隔离**：如果需要在不同会话中使用不同的 bucket，使用 `sessionId` 参数
5. **路径管理**：记录已挂载的路径，避免重复挂载或卸载不存在的路径

### 性能考虑

- Bucket 挂载使用 s3fs，首次访问文件时会有网络延迟
- 大文件操作建议使用流式处理，避免一次性加载到内存
- 频繁的小文件操作可能较慢，考虑批量处理或使用缓存
